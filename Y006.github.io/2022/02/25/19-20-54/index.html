<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <link rel="manifest" href="/manifest.json">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"y006.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.10.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":{"disqus":{"text":"Load Disqus","order":-1},"gitalk":{"order":-2}}},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

  <meta name="description" content="双轮自平衡小车制作指南 整体介绍 这将会是我制作自平衡小车的一个开始，本文的目标在于设计一个简单的自平衡小车，实现自平衡站立和行进。作品将依托于开源硬件平台Arduino，使用C语言进行程序开发。 双轮小车与四轮小车不同，双轮小车本身是一个欠稳定系统。将一个双轮小车直立着放在地面上时，小车难以站立，而是会向前或者向后倾倒。若要使小车维持稳定站立，我们需要引入一个控制系统。当小车将要向前倾倒时">
<meta property="og:type" content="website">
<meta property="og:title" content="双轮自平衡小车制作指南">
<meta property="og:url" content="https://y006.github.io/2022/02/25/19-20-54/index.html">
<meta property="og:site_name" content="Blog">
<meta property="og:description" content="双轮自平衡小车制作指南 整体介绍 这将会是我制作自平衡小车的一个开始，本文的目标在于设计一个简单的自平衡小车，实现自平衡站立和行进。作品将依托于开源硬件平台Arduino，使用C语言进行程序开发。 双轮小车与四轮小车不同，双轮小车本身是一个欠稳定系统。将一个双轮小车直立着放在地面上时，小车难以站立，而是会向前或者向后倾倒。若要使小车维持稳定站立，我们需要引入一个控制系统。当小车将要向前倾倒时">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://y006.github.io/2022/02/25/19-20-54/image-20220226162323982.png">
<meta property="og:image" content="https://y006.github.io/2022/02/25/19-20-54/照片预览_2022-02-27-16459370460521.svg">
<meta property="og:image" content="https://y006.github.io/2022/02/25/19-20-54/image-20220226162741791.png">
<meta property="article:published_time" content="2022-02-25T11:20:54.000Z">
<meta property="article:modified_time" content="2022-05-31T15:54:35.442Z">
<meta property="article:author" content="邱金羽">
<meta property="article:tag" content="电子设计">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://y006.github.io/2022/02/25/19-20-54/image-20220226162323982.png">


<link rel="canonical" href="https://y006.github.io/2022/02/25/19-20-54/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://y006.github.io/2022/02/25/19-20-54/","path":"2022/02/25/19-20-54/","title":"双轮自平衡小车制作指南"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>双轮自平衡小车制作指南 | Blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">邱金羽的技术博客！</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%8C%E8%BD%AE%E8%87%AA%E5%B9%B3%E8%A1%A1%E5%B0%8F%E8%BD%A6%E5%88%B6%E4%BD%9C%E6%8C%87%E5%8D%97"><span class="nav-number">1.</span> <span class="nav-text">双轮自平衡小车制作指南</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B4%E4%BD%93%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.0.1.</span> <span class="nav-text">整体介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9D%90%E6%96%99%E5%87%86%E5%A4%87"><span class="nav-number">1.0.2.</span> <span class="nav-text">材料准备</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#arduino-nano-%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.0.3.</span> <span class="nav-text">Arduino Nano 介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9D%E5%A7%8Barduino"><span class="nav-number">1.0.3.1.</span> <span class="nav-text">初始Arduino</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E9%AA%8C1%E6%8E%A7%E5%88%B6"><span class="nav-number">1.0.3.2.</span> <span class="nav-text">实验1——控制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E9%AA%8C2%E9%80%9A%E4%BF%A1"><span class="nav-number">1.0.3.3.</span> <span class="nav-text">实验2——通信</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E9%AA%8C3"><span class="nav-number">1.0.3.4.</span> <span class="nav-text">实验3——</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%B5%E6%9C%BA%E5%9F%BA%E7%A1%80"><span class="nav-number">1.0.4.</span> <span class="nav-text">电机基础</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%86%E8%A7%A3%E7%9B%B4%E6%B5%81%E7%94%B5%E6%9C%BA"><span class="nav-number">1.0.4.1.</span> <span class="nav-text">了解直流电机</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%84%89%E5%86%B2%E5%AE%BD%E5%BA%A6%E8%B0%83%E5%88%B6pwm"><span class="nav-number">1.0.4.2.</span> <span class="nav-text">脉冲宽度调制（PWM）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#pwm%E7%AE%80%E4%BB%8B"><span class="nav-number">1.0.4.2.1.</span> <span class="nav-text">PWM简介*</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9C%A8arduino%E4%B8%AD%E4%BD%BF%E7%94%A8pwm"><span class="nav-number">1.0.4.2.2.</span> <span class="nav-text">在Arduino中使用PWM</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%96%E7%A0%81%E5%99%A8"><span class="nav-number">1.0.4.3.</span> <span class="nav-text">编码器</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mpu6050"><span class="nav-number">1.0.5.</span> <span class="nav-text">MPU6050</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%9F%E5%A7%8B%E6%95%B0%E6%8D%AE"><span class="nav-number">1.0.5.1.</span> <span class="nav-text">原始数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E5%AD%97%E6%BB%A4%E6%B3%A2%E5%99%A8"><span class="nav-number">1.0.5.2.</span> <span class="nav-text">数字滤波器</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pid%E6%8E%A7%E5%88%B6"><span class="nav-number">1.0.6.</span> <span class="nav-text">PID控制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#d%E5%BB%BA%E6%A8%A1%E5%88%B6%E4%BD%9C%E5%B0%8F%E8%BD%A6%E5%A4%96%E5%A3%B3"><span class="nav-number">1.0.7.</span> <span class="nav-text">3D建模——制作小车外壳</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pcb%E8%AE%BE%E8%AE%A1%E5%88%B6%E4%BD%9C%E5%B0%8F%E8%BD%A6%E7%94%B5%E8%B7%AF%E6%9D%BF"><span class="nav-number">1.0.8.</span> <span class="nav-text">PCB设计——制作小车电路板</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="邱金羽"
      src="/images/custom-logo.jpg">
  <p class="site-author-name" itemprop="name">邱金羽</p>
  <div class="site-description" itemprop="description">联系我：2420457716@qq.com</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">27</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://space.bilibili.com/32844822/dynamic" title="Bilibili个人空间 → https:&#x2F;&#x2F;space.bilibili.com&#x2F;32844822&#x2F;dynamic" rel="noopener" target="_blank">Bilibili个人空间</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.zhihu.com/people/qiu-jin-yu-60" title="知乎 → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;qiu-jin-yu-60" rel="noopener" target="_blank">知乎</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      友链
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://uinika.github.io/" title="https:&#x2F;&#x2F;uinika.github.io&#x2F;" rel="noopener" target="_blank">UinIO</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://fazzie-key.cool/" title="https:&#x2F;&#x2F;fazzie-key.cool&#x2F;" rel="noopener" target="_blank">摸黑干活</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://eater.net/" title="https:&#x2F;&#x2F;eater.net&#x2F;" rel="noopener" target="_blank">Ben Eater</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://blog.52diy.com.cn/" title="https:&#x2F;&#x2F;blog.52diy.com.cn&#x2F;" rel="noopener" target="_blank">52diy</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://gaoyichao.com/Xiaotu/" title="https:&#x2F;&#x2F;gaoyichao.com&#x2F;Xiaotu&#x2F;" rel="noopener" target="_blank">小土的世界</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://stm32f4-discovery.net/" title="https:&#x2F;&#x2F;stm32f4-discovery.net&#x2F;" rel="noopener" target="_blank">Tilen Majerle</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://mculover666.blog.csdn.net/" title="https:&#x2F;&#x2F;mculover666.blog.csdn.net&#x2F;" rel="noopener" target="_blank">Mculover666</a>
        </li>
    </ul>
  </div>

        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/yourname" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://y006.github.io/2022/02/25/19-20-54/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/custom-logo.jpg">
      <meta itemprop="name" content="邱金羽">
      <meta itemprop="description" content="联系我：2420457716@qq.com">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          双轮自平衡小车制作指南
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-02-25 19:20:54" itemprop="dateCreated datePublished" datetime="2022-02-25T19:20:54+08:00">2022-02-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-05-31 23:54:35" itemprop="dateModified" datetime="2022-05-31T23:54:35+08:00">2022-05-31</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2022/02/25/19-20-54/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2022/02/25/19-20-54/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="双轮自平衡小车制作指南">双轮自平衡小车制作指南</h1>
<h3 id="整体介绍">整体介绍</h3>
<p>这将会是我制作自平衡小车的一个开始，本文的目标在于设计一个简单的自平衡小车，实现自平衡站立和行进。作品将依托于开源硬件平台Arduino，使用C语言进行程序开发。</p>
<p>双轮小车与四轮小车不同，双轮小车本身是一个欠稳定系统。将一个双轮小车直立着放在地面上时，小车难以站立，而是会向前或者向后倾倒。若要使小车维持稳定站立，我们需要引入一个控制系统。当小车将要向前倾倒时，控制电机带动轮胎向前移动，便阻止了小车前倾；同理可知小车后倾时可以向后移动阻止后倾，从而实现小车的平衡。</p>
<p>为了实现上述的控制，首先我们需要实时获取小车的“姿态”，即小车向前倾倒还是向后倾倒，以及倾倒的程度（一般使用角度来表示这个倾倒的程度）。“姿态”的获取需要使用可以测量加速度和角加速度的传感器，这种传感器被称作惯性测量单元 (IMU)，惯性测量单元获取的数据可以帮助我们获取小车“姿态”。</p>
<p>第二步是依据小车的“姿态”，控制电机活动，具体的控制内容包括电机的转速和转向。</p>
<h3 id="材料准备">材料准备</h3>
<p>实现一个最基础的平衡小车需要以下组件：</p>
<ul>
<li>微控制器：Arduino Nano 开发板</li>
<li>惯性测量单元 (IMU) ：MPU6050模块</li>
<li>电机：
<ul>
<li>N20减速直流电机（带霍尔编码器，详细参数见后文）</li>
<li>双母头电机端子线（型号：ZH1.5MM）</li>
<li>端子线贴片插座（型号：ZH1.5MM）</li>
</ul></li>
<li>电源：
<ul>
<li>7.4V锂电池</li>
<li>AMS1117降压电源模块（5V）</li>
<li>USB-Typec母头（带PCB板）</li>
</ul></li>
<li>外壳：3D打印外壳</li>
<li>电路板：立创EDA设计原理图和PCB板</li>
<li>其他：
<ul>
<li>N20减速直流电机配套固定架和D字轴轮胎</li>
<li>螺丝螺母</li>
<li>面包板和杜邦线（学习和测试时使用，实际小车中不使用）</li>
<li></li>
</ul></li>
</ul>
<h3 id="arduino-nano-介绍">Arduino Nano 介绍</h3>
<h4 id="初始arduino">初始Arduino</h4>
<p>Arduino是一款开源的嵌入式硬件开发平台，不仅包括了众多型号的开发板，而且包括了一个集成开发环境（IDE）辅助开发者编程，烧录和通信。Arduino本身提供了许多标准库，这些库的封装程度高，因此用户不必去关心寄存器配置而是可以通过库函数的调用来实现各种功能。Arduino作为一个受欢迎的开源平台，在互联网上可以找到大量的资料和例程进行学习。除了上文提到的标准库之外，Arduino还有各种用户针对不同外设写的库，可以在Arduino中轻松的获取和使用。Arduino本身还提供有图形化编程选项，即便是不会编程的非专业人士也可以快速上手。Arduino帮助我们从嵌入式硬件开发底层的细节中挣脱出来，把注意力放在控制本身这件事上。而且，鉴于本文的希望依托于一个可靠的开源平台且尽可能构造一个简单的自平衡小车，因此Arduino平台成为了我的首选。</p>
<p>进行电子设计时，我们首先要确定控制核心的选择。在这里我们选择了Arduino里面的Nano开发板进行开发。下图是Nano的模型图/引脚图。</p>
<p><img src="/2022/02/25/19-20-54/image-20220226162323982.png" alt="image-20220226162323982" style="zoom:67%;"></p>
<p>第一次接触硬件设计的人可能看到这张图会感到很复杂且不知所措。因此接下来我们将会通过一些实验来认识Nano。在结束这一章时再次回来看这张图片，或许你就会感到亲切了。</p>
<h4 id="实验1控制">实验1——控制</h4>
<p>Ardino是一块开源的嵌入式硬件平台，这句话对于初学者来说可能会是一个巨大的困扰，因为嵌入式是何意义，向初学者“正确”的解释清楚这件事并不容易。但是，不理解这段话并不影响我们去使用Arduino Nano来进行一些小开发。我们只需要牢牢记住一件事，那就是Nano是一个微控制器，微就是微小的意思，Nano就是个小型的控制器。控制器就是用来做控制的。接下来我们先从一个简单的实验入手，使用这个控制器去做一些控制。</p>
<p>首先我们先理解控制的概念，我们会希望控制什么呢？可能有人说，控制机器人！或者是控制一个遥控飞机飞行！是的，这些是控制，但是这种难度的控制并不适合一个初学者去学习。其实，控制无处不在，比如，我们按下开关，就可以打开灯，开关就是一个控制器，控制着灯的亮灭。现在，让我们把开关换成Nano，用它来控制一个LED小灯的亮灭。</p>
<p>实验需要准备：</p>
<ul>
<li>Arduino Nano开发板（焊接好排针），Arduino IDE，Micro USB接口的数据线</li>
<li>面包板和杜邦线（双公头）</li>
<li>LED灯和电阻</li>
</ul>
<p>首先，按照下图的方法连接电路。</p>
<p>然后打开Arduino IDE：用数据线将Nano与电脑相连接，选择相应的型号的开发板和端口，在编辑器中写入代码，然后点击编译并烧录，具体操作如下图：</p>
<p>图中代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">LED = <span class="number">7</span>;               <span class="comment">// 给D7引脚重命名为LED</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  pinMode(LED, OUTPUT);        <span class="comment">// 将名为LED的引脚设置为（数字）输出</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  digitalWrite(LED, HIGH);       <span class="comment">// 向LED引脚进行写入“高”，表示输出高电平</span></span><br><span class="line">  delay(<span class="number">1000</span>);                       <span class="comment">// 延时1000ms即1秒</span></span><br><span class="line">  digitalWrite(LED, LOW);        <span class="comment">// 向LED引脚进行写入“低”，表示输出低电平</span></span><br><span class="line">  delay(<span class="number">1000</span>);                       <span class="comment">// 延时1000ms即1秒</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完成上述操作后，就能看到LED亮一秒，灭一秒了。</p>
<p>使用模拟量（analogWrite(Pin,Value)函数的本质是PWM驱动）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> byte GND = <span class="number">5</span>;</span><br><span class="line"><span class="type">const</span> byte LED = <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  pinMode(GND, OUTPUT);</span><br><span class="line">  pinMode(LED, OUTPUT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  analogWrite(GND, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">250</span>; i = i + <span class="number">50</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    analogWrite(LED, i);</span><br><span class="line">    delay(<span class="number">500</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  analogWrite(LED, <span class="number">0</span>);</span><br><span class="line">  delay(<span class="number">1500</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="实验2通信">实验2——通信</h4>
<h4 id="实验3">实验3——</h4>
<h3 id="电机基础">电机基础</h3>
<h4 id="了解直流电机">了解直流电机</h4>
<p>学习和使用电机之前，我们首先要对电机的基本原理有一定的认识。最基础的电机的是我们在中学阶段就学习过的直流电机。直流电机是一个放在磁场中的导线转子，当有直流电流过导线转子时，转子便受力旋转。直流电机通入直流后转子转速很快，但是其扭矩——或者说转动的力度，很小。但是为了能带动轮胎转动实现小车行进，我们需要转子拥有较大的扭矩。于是我们有了减速直流电机。减速直流电机相比于直流电机多了一个减速箱。减速箱内部有许多齿轮，转子转动带动减速箱内部的齿轮转动，这一过程将导致转轴转速降低而扭矩提高，因此我们称其为减速电机。减速电机中最重要的参数是减速比。减速比的大小等于减速箱外的转轴转一圈时直流电机转子转过的圈数。我们使用的N20电机就是一个减速直流电机。</p>
<p>驱动直流电机的方法非常简单，只需要在电机的两个端子上接上正负电压，电机便开始转动。若是交换两端子上的电压，则电机会沿于之前相反的方向转动。对于装有编码器的N20电机来说，标注为M1和M2的端子为直流电机的端子。</p>
<p>为了更全面的理解电机，我们应该了解另一种常见的电机类型——步进电机，以便在其他时候遇到的话不至于与现在所学的电机相混淆。步进电机是一种可以顾名思义的东西，只不过大多数人在最开始想到的含义可以不太正确。步进电机不是专指用来前进或者行进的电机，毕竟很显然的是，只要外界轮子，直流电机也可以前进。步进电机这个名字来源于电机的内部构造，转子在脉冲信号输入下发生一步一步的转动，这种一步一步的转动的效果有点像钟表的秒针，每一秒在表盘上走一小步，一步一步的旋转，最终一分钟后旋转了一圈。如果我们加快这一过程，这样电机就不再是做一顿一顿的运动了，而是一个连续不断的快速的旋转。</p>
<p>步进电机只是转子旋转的原理和直流电机不同，但是依然可以在步进电机外接入减速箱。这两个电机的定语是两种平行的分类方式，这点不要混淆。</p>
<p>我们回到上文的直流电机，如果想要了解更多关于步进电机的知识，可以在搜索引擎上搜索“步进电机”，在这里我只是做简单的介绍。</p>
<p>直流电机有两个端子，施加正负电压即可驱动马达转动，交换正负电压就可以改变马达转向。前者非常简单，只需要提供一个外接直流电源，或者使用Nano的5V引脚和GND引脚就可以驱动电机转动，手动改变电流源极性或者使用微控制器调整输出电压信号都可以改变马达转向。但是如开篇我们所说的，我们需要同时控制电机转速和转向。为此，我们需要学习使用一种要脉冲宽度调制（Pulse-width modulation）的技术来控制电机的转速。下面我们就来详细地了解一下PWM技术，并且使用Nano来控制电机的转速和转向。</p>
<h4 id="脉冲宽度调制pwm">脉冲宽度调制（PWM）</h4>
<h5 id="pwm简介">PWM简介*</h5>
<p>TODO</p>
<h5 id="在arduino中使用pwm">在Arduino中使用PWM</h5>
<p>TODO</p>
<h4 id="编码器">编码器</h4>
<p>TODO</p>
<h3 id="mpu6050">MPU6050</h3>
<h4 id="原始数据">原始数据</h4>
<p>双轮自平衡小车使用的惯性测量单元 (IMU) 是MPU6050，包含一个三轴的加速度传感器和一个三轴的陀螺仪。加速度传感器可以获取运动的物体在三个坐标轴方向上的加速度，陀螺仪可以获取绕坐标轴旋转的物体的角加速度。</p>
<p>对于双轮自平衡小车，我们需要其在一个坐标轴方向上的角度信息。从小车侧面看，仅有可能向左右两个方向倾倒，而不会向前后倾倒，并且小车的静止和行进都是在地面这个水平面进行，因此不需要关心Z轴上的变化。因此，设计一个自平衡小车，我们只需要关注其绕X轴或是绕Y轴的角度（取决于模块的放置方式）问题即可。</p>
<p>在本次设计中，我将按照下图的方式放置MPU6050，因此我们关注的是绕X轴的角度变化。</p>
<figure>
<img src="/2022/02/25/19-20-54/照片预览_2022-02-27-16459370460521.svg" alt="照片预览_2022-02-27"><figcaption aria-hidden="true">照片预览_2022-02-27</figcaption>
</figure>
<p>为了实时获取小车的角度信息，我们需要同时使用加速度传感器和陀螺仪。单独测试MPU6050模块时，可以将将MPU6050模块的VCC引脚接Nano的5V引脚，MPU6050模块的GND引脚接Nano的GND引脚。接入电源后模块便能实时产生六个数据（实际数据比六个多，还包括温度数据，这里不进行介绍），我们使用<span class="math inline">\(I^2C\)</span>通信方式进行MPU6050模块和Nano之间的通信。进行<span class="math inline">\(I^2C\)</span>通信时，首先要将MPU6050模块的SCL引脚与Nano的SCL引脚相连，MPU6050模块的SDA引脚与Nano的SDA引脚相连。但是，这里存在一个问题是，在Nano的PCB板上我们找不到名为SCL与SDA的引脚。这时候我们就要回到文章开头的那张Nano引脚图了。</p>
<p><img src="/2022/02/25/19-20-54/image-20220226162741791.png" alt="image-20220226162741791" style="zoom: 50%;"></p>
<p>在图中我们可以看到Nano的A4引脚外面写着SDA，A5引脚外写着SCL，其实这是表示引脚的公用，即A4引脚既能做一个单纯的模拟引脚使用，也可以作为SDA引脚使用。因此，为了将MPU6050中产生的数据导入到Nano中，我们MPU6050模块的SDA引脚与Nano的A4引脚相连，SCL与A5相连。连接好之后，我们就可以通过代码来进行程序读取了。</p>
<p>使用Arduino进行<span class="math inline">\(I^2C\)</span>通信一般需要用到“Wire.h”这个标准库，使用“Wire.h”我们首先要将它包含进来。使用时，首先要进行初始化，与串口通信相似。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Wire.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  Wire.begin();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果我们想要读取MPU6050中的数据，我们需要知道其地址，然后进行数据传输，具体的代码操作如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Wire.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> MPU = <span class="number">0x68</span>; <span class="comment">// MPU6050 I2C 地址</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  Wire.begin();</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//配置MPU6050的加速度计模块</span></span><br><span class="line">  Wire.beginTransmission(MPU);</span><br><span class="line">  Wire.write(<span class="number">0x1C</span>);</span><br><span class="line">  Wire.write(<span class="number">0x00</span>);</span><br><span class="line">  Wire.endTransmission(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们本阶段的目标在于读取MPU6050中的原始数据，包括三个坐标方向上的加速度信息和三个方向上的角加速度信息。为了存储这些读取来的数据，我们设置了6个浮点数类型的变量</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">float</span> AccX, AccY, AccZ;</span><br><span class="line"><span class="type">float</span> GyroX, GyroY, GyroZ;</span><br></pre></td></tr></table></figure>
<p>来存储数据，之所以是变量数据类型而不是数组，因为这6个信息是实时测量值，在loop()这个函数中每一列都会获取当下的这六个数据，并立即进行处理，通过数学运算获取实时的角度信息，而下一刻的角度信息则有下一刻的六个数据计算得来。loop()函数中实时获取六个数据的方法如下。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">//读取加速度的值：</span></span><br><span class="line">  <span class="comment">//开启加速度计模块</span></span><br><span class="line">  Wire.beginTransmission(MPU);</span><br><span class="line">  Wire.write(<span class="number">0x3B</span>);</span><br><span class="line">  Wire.endTransmission(<span class="literal">false</span>);</span><br><span class="line">  Wire.requestFrom(MPU, <span class="number">6</span>, <span class="literal">true</span>);</span><br><span class="line">  <span class="comment">//从MPU6050中读取加速度数据并转化为g为单位的通用数据</span></span><br><span class="line">  AccX = (Wire.read() &lt;&lt; <span class="number">8</span> | Wire.read()) / <span class="number">16384.0</span>;</span><br><span class="line">  AccY = (Wire.read() &lt;&lt; <span class="number">8</span> | Wire.read()) / <span class="number">16384.0</span>;</span><br><span class="line">  AccZ = (Wire.read() &lt;&lt; <span class="number">8</span> | Wire.read()) / <span class="number">16384.0</span>;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">//读取角加速度的值：</span></span><br><span class="line">  <span class="comment">//开启角加速度模块</span></span><br><span class="line">  Wire.beginTransmission(MPU);</span><br><span class="line">  Wire.write(<span class="number">0x43</span>);</span><br><span class="line">  Wire.endTransmission(<span class="literal">false</span>);</span><br><span class="line">  Wire.requestFrom(MPU, <span class="number">6</span>, <span class="literal">true</span>);</span><br><span class="line">  <span class="comment">//从MPU6050中读取角加速度数据并转化为g为单位的通用数据</span></span><br><span class="line">  GyroX = (Wire.read() &lt;&lt; <span class="number">8</span> | Wire.read()) / <span class="number">131.0</span>;</span><br><span class="line">  GyroY = (Wire.read() &lt;&lt; <span class="number">8</span> | Wire.read()) / <span class="number">131.0</span>;</span><br><span class="line">  GyroZ = (Wire.read() &lt;&lt; <span class="number">8</span> | Wire.read()) / <span class="number">131.0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>代码中，以</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AccX = (Wire.read() &lt;&lt; <span class="number">8</span> | Wire.read()) / <span class="number">16384.0</span>;</span><br></pre></td></tr></table></figure>
<p>为例，在MPU6050中直接读取的数据为<span class="math inline">\(AccX*16384.0\)</span>，之所以这里要将<span class="math inline">\(16384.0\)</span>这个数字除掉，其实是在进行单位转换，将加速度的单位转化为<span class="math inline">\(g\)</span>，这里的<span class="math inline">\(g=9.8\)</span>其实就是重力加速度。这里之所以将加速度的单位统一为重力加速度，是因为从原理上看，加速度计测量加速度原理就是以重力加速度为参考求出来的，所以一般将加速度的单位设为重力加速度。</p>
<p>使用上述代码</p>
<h4 id="数字滤波器">数字滤波器</h4>
<p>TODO</p>
<p>一阶互补滤波器（仅roll值）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Wire.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> MPU = <span class="number">0x68</span>; <span class="comment">// MPU6050 I2C address</span></span><br><span class="line"><span class="type">float</span> AccX, AccY, AccZ;</span><br><span class="line"><span class="type">float</span> GyroX;</span><br><span class="line"><span class="type">float</span> accAngleX, gyroAngleX;</span><br><span class="line"><span class="type">float</span> roll;</span><br><span class="line"><span class="type">float</span> elapsedTime, currentTime, previousTime;</span><br><span class="line"><span class="type">float</span> AccErrorX = <span class="number">-1.5</span>,GyroErrorX = <span class="number">-0.25</span>,rollError = <span class="number">-3.2</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> </span><br><span class="line">&#123;</span><br><span class="line">  Serial.begin(<span class="number">19200</span>);</span><br><span class="line">  Wire.begin();                      <span class="comment">// Initialize comunication</span></span><br><span class="line">  Wire.beginTransmission(MPU);       <span class="comment">// Start communication with MPU6050 // MPU=0x68</span></span><br><span class="line">  Wire.write(<span class="number">0x6B</span>);                  <span class="comment">// Talk to the register 6B</span></span><br><span class="line">  Wire.write(<span class="number">0x00</span>);                  <span class="comment">// Make reset - place a 0 into the 6B register</span></span><br><span class="line">  Wire.endTransmission(<span class="literal">true</span>);        <span class="comment">//end the transmission</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> </span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// === Read acceleromter data === //</span></span><br><span class="line">  Wire.beginTransmission(MPU);</span><br><span class="line">  Wire.write(<span class="number">0x3B</span>); </span><br><span class="line">  Wire.endTransmission(<span class="literal">false</span>);</span><br><span class="line">  Wire.requestFrom(MPU, <span class="number">6</span>, <span class="literal">true</span>); </span><br><span class="line">    </span><br><span class="line">  AccX = (Wire.read() &lt;&lt; <span class="number">8</span> | Wire.read()) / <span class="number">16384.0</span>;</span><br><span class="line">  AccY = (Wire.read() &lt;&lt; <span class="number">8</span> | Wire.read()) / <span class="number">16384.0</span>; <span class="comment">// Y-axis value</span></span><br><span class="line">  AccZ = (Wire.read() &lt;&lt; <span class="number">8</span> | Wire.read()) / <span class="number">16384.0</span>; <span class="comment">// Z-axis value</span></span><br><span class="line">  accAngleX = (<span class="built_in">atan</span>(AccY / <span class="built_in">sqrt</span>(<span class="built_in">pow</span>(AccX, <span class="number">2</span>) + <span class="built_in">pow</span>(AccZ, <span class="number">2</span>))) * <span class="number">180</span> / PI) - AccErrorX;</span><br><span class="line">   </span><br><span class="line">  <span class="comment">// === Read gyroscope data === //</span></span><br><span class="line">  previousTime = currentTime;</span><br><span class="line">  currentTime = millis();</span><br><span class="line">  elapsedTime = (currentTime - previousTime) / <span class="number">1000</span>;</span><br><span class="line">    </span><br><span class="line">  Wire.beginTransmission(MPU);</span><br><span class="line">  Wire.write(<span class="number">0x43</span>);</span><br><span class="line">  Wire.endTransmission(<span class="literal">false</span>);</span><br><span class="line">  Wire.requestFrom(MPU, <span class="number">6</span>, <span class="literal">true</span>); </span><br><span class="line">    </span><br><span class="line">  GyroX = (Wire.read() &lt;&lt; <span class="number">8</span> | Wire.read()) / <span class="number">131.0</span>;</span><br><span class="line">  GyroX = GyroX - GyroErrorX;</span><br><span class="line">  gyroAngleX = gyroAngleX + GyroX * elapsedTime;</span><br><span class="line">  </span><br><span class="line">  roll = <span class="number">0.96</span> * gyroAngleX + <span class="number">0.04</span> * accAngleX -rollError;</span><br><span class="line">  Serial.println(roll);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>卡尔曼滤波器</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Wire.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">float</span> <span class="title function_">kalman</span><span class="params">(<span class="type">float</span> y)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">float</span> x = <span class="number">1</span>;</span><br><span class="line">    <span class="type">static</span> <span class="type">float</span> p = <span class="number">5</span>;</span><br><span class="line">    <span class="type">static</span> <span class="type">float</span> q = <span class="number">0.2</span>; <span class="comment">//important</span></span><br><span class="line">    <span class="type">static</span> <span class="type">float</span> r = <span class="number">1</span>;   <span class="comment">//important</span></span><br><span class="line">    <span class="type">static</span> <span class="type">float</span> kg;</span><br><span class="line"></span><br><span class="line">    p = p + q;</span><br><span class="line">    kg = p / (p + r);</span><br><span class="line">    x = x + kg * (y - x);</span><br><span class="line">    p = (<span class="number">1</span> - kg) * p;</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//******卡尔曼参数************</span></span><br><span class="line"><span class="type">static</span> <span class="type">float</span> Q_angle = <span class="number">0.001</span>;<span class="comment">//角度数据置信度</span></span><br><span class="line"><span class="type">static</span> <span class="type">float</span> Q_gyro  = <span class="number">0.005</span>;<span class="comment">//角速度数据置信度</span></span><br><span class="line"><span class="type">static</span> <span class="type">float</span> R_angle = <span class="number">0.5</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">float</span> dt  = <span class="number">0.004</span>;    <span class="comment">//dt为kalman滤波器采样时间;</span></span><br><span class="line"><span class="type">static</span> <span class="type">char</span>  C_0 = <span class="number">1</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">float</span> Q_bias, Angle_err;</span><br><span class="line"><span class="type">static</span> <span class="type">float</span> PCt_0, PCt_1, E;</span><br><span class="line"><span class="type">static</span> <span class="type">float</span> K_0, K_1, t_0, t_1;</span><br><span class="line"><span class="type">static</span> <span class="type">float</span> Pdot[<span class="number">4</span>]  = &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">static</span> <span class="type">float</span> PP[<span class="number">2</span>][<span class="number">2</span>] = &#123; &#123; <span class="number">1</span>, <span class="number">0</span> &#125;, &#123; <span class="number">0</span>, <span class="number">1</span> &#125; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> Angle;</span><br><span class="line"><span class="type">float</span> Gyro_y;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> MPU = <span class="number">0x68</span>; <span class="comment">// MPU6050 I2C address</span></span><br><span class="line"><span class="type">float</span> AccX, AccY, AccZ;</span><br><span class="line"><span class="type">float</span> GyroX, GyroY, GyroZ;</span><br><span class="line"><span class="type">float</span> accAngleX, accAngleY, gyroAngleX, gyroAngleY, gyroAngleZ;</span><br><span class="line"><span class="type">float</span> roll, pitch, yaw;</span><br><span class="line"><span class="type">float</span> AccErrorX, AccErrorY, GyroErrorX, GyroErrorY, GyroErrorZ;</span><br><span class="line"><span class="type">float</span> elapsedTime, currentTime, previousTime;</span><br><span class="line"><span class="type">static</span> <span class="type">float</span> atan_coeff  = <span class="number">57.3f</span>;   <span class="comment">//arctan转换角度系数</span></span><br><span class="line"><span class="type">float</span> angle_a,angle_g;</span><br><span class="line"><span class="type">static</span> <span class="type">float</span> gro_zero  = <span class="number">24.05f</span>;    <span class="comment">//角速度为0时的校准值</span></span><br><span class="line"><span class="type">static</span> <span class="type">float</span> gro_coeff = <span class="number">-0.0645f</span>;  <span class="comment">//角速度对应角度变化系数</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">float</span> Angle, Gyro_y;         <span class="comment">//kalman融合后得出的最优角度和角速度</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> ave_num = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Kalman_Filter</span><span class="params">(<span class="type">float</span> Accel, <span class="type">float</span> Gyro)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">calculate_IMU_error</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> </span><br><span class="line">&#123;</span><br><span class="line">  Serial.begin(<span class="number">19200</span>);</span><br><span class="line">  Wire.begin();                      <span class="comment">// Initialize comunication</span></span><br><span class="line">  Wire.beginTransmission(MPU);       <span class="comment">// Start communication with MPU6050 // MPU=0x68</span></span><br><span class="line">  Wire.write(<span class="number">0x6B</span>);                  <span class="comment">// Talk to the register 6B</span></span><br><span class="line">  Wire.write(<span class="number">0x00</span>);                  <span class="comment">// Make reset - place a 0 into the 6B register</span></span><br><span class="line">  Wire.endTransmission(<span class="literal">true</span>);        <span class="comment">//end the transmission</span></span><br><span class="line">  calculate_IMU_error();</span><br><span class="line">  delay(<span class="number">20</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> </span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// === Read acceleromter data === //</span></span><br><span class="line">  Wire.beginTransmission(MPU);</span><br><span class="line">  Wire.write(<span class="number">0x3B</span>); </span><br><span class="line">  Wire.endTransmission(<span class="literal">false</span>);</span><br><span class="line">  Wire.requestFrom(MPU, <span class="number">6</span>, <span class="literal">true</span>); </span><br><span class="line">    </span><br><span class="line">  AccX = (Wire.read() &lt;&lt; <span class="number">8</span> | Wire.read()) / <span class="number">16384.0</span>;</span><br><span class="line">  AccY = (Wire.read() &lt;&lt; <span class="number">8</span> | Wire.read()) / <span class="number">16384.0</span>; <span class="comment">// Y-axis value</span></span><br><span class="line">  AccZ = (Wire.read() &lt;&lt; <span class="number">8</span> | Wire.read()) / <span class="number">16384.0</span>; <span class="comment">// Z-axis value</span></span><br><span class="line">  accAngleX = (<span class="built_in">atan</span>(AccY / <span class="built_in">sqrt</span>(<span class="built_in">pow</span>(AccX, <span class="number">2</span>) + <span class="built_in">pow</span>(AccZ, <span class="number">2</span>))) * <span class="number">180</span> / PI) - AccErrorX;</span><br><span class="line">   </span><br><span class="line">  <span class="comment">// === Read gyroscope data === //</span></span><br><span class="line">  previousTime = currentTime;</span><br><span class="line">  currentTime = millis();</span><br><span class="line">  elapsedTime = (currentTime - previousTime) / <span class="number">1000</span>;</span><br><span class="line">    </span><br><span class="line">  Wire.beginTransmission(MPU);</span><br><span class="line">  Wire.write(<span class="number">0x43</span>);</span><br><span class="line">  Wire.endTransmission(<span class="literal">false</span>);</span><br><span class="line">  Wire.requestFrom(MPU, <span class="number">6</span>, <span class="literal">true</span>); </span><br><span class="line">    </span><br><span class="line">  GyroX = (Wire.read() &lt;&lt; <span class="number">8</span> | Wire.read()) / <span class="number">131.0</span>;</span><br><span class="line">  GyroX = GyroX - GyroErrorX;</span><br><span class="line">  gyroAngleX = gyroAngleX + GyroX * elapsedTime;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//angle_a = (float)atan((float)AccX/AccZ)*atan_coeff;</span></span><br><span class="line">  angle_a = accAngleX; </span><br><span class="line">  angle_g = gyroAngleX;</span><br><span class="line">  Kalman_Filter(angle_a, angle_g);</span><br><span class="line">  Serial.println(Angle);</span><br><span class="line">  <span class="comment">//Serial.println(Gyro_y);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">calculate_IMU_error</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// We can call this funtion in the setup section to calculate the accelerometer and gyro data error. From here we will get the error values used in the above equations printed on the Serial Monitor.</span></span><br><span class="line">  <span class="comment">// Note that we should place the IMU flat in order to get the proper values, so that we then can the correct values</span></span><br><span class="line">  <span class="comment">// Read accelerometer values 200 times</span></span><br><span class="line">  <span class="keyword">while</span> (ave_num &lt; <span class="number">200</span>) &#123;</span><br><span class="line">    Wire.beginTransmission(MPU);</span><br><span class="line">    Wire.write(<span class="number">0x3B</span>);</span><br><span class="line">    Wire.endTransmission(<span class="literal">false</span>);</span><br><span class="line">    Wire.requestFrom(MPU, <span class="number">6</span>, <span class="literal">true</span>);</span><br><span class="line">    AccX = (Wire.read() &lt;&lt; <span class="number">8</span> | Wire.read()) / <span class="number">16384.0</span> ;</span><br><span class="line">    AccY = (Wire.read() &lt;&lt; <span class="number">8</span> | Wire.read()) / <span class="number">16384.0</span> ;</span><br><span class="line">    AccZ = (Wire.read() &lt;&lt; <span class="number">8</span> | Wire.read()) / <span class="number">16384.0</span> ;</span><br><span class="line">    <span class="comment">// Sum all readings</span></span><br><span class="line">    AccErrorX = AccErrorX + ((<span class="built_in">atan</span>((AccY) / <span class="built_in">sqrt</span>(<span class="built_in">pow</span>((AccX), <span class="number">2</span>) + <span class="built_in">pow</span>((AccZ), <span class="number">2</span>))) * <span class="number">180</span> / PI));</span><br><span class="line">    AccErrorY = AccErrorY + ((<span class="built_in">atan</span>(<span class="number">-1</span> * (AccX) / <span class="built_in">sqrt</span>(<span class="built_in">pow</span>((AccY), <span class="number">2</span>) + <span class="built_in">pow</span>((AccZ), <span class="number">2</span>))) * <span class="number">180</span> / PI));</span><br><span class="line">    ave_num++;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//Divide the sum by 200 to get the error value</span></span><br><span class="line">  AccErrorX = AccErrorX / <span class="number">200</span>;</span><br><span class="line">  AccErrorY = AccErrorY / <span class="number">200</span>;</span><br><span class="line">  ave_num = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// Read gyro values 200 times</span></span><br><span class="line">  <span class="keyword">while</span> (ave_num &lt; <span class="number">200</span>) &#123;</span><br><span class="line">    Wire.beginTransmission(MPU);</span><br><span class="line">    Wire.write(<span class="number">0x43</span>);</span><br><span class="line">    Wire.endTransmission(<span class="literal">false</span>);</span><br><span class="line">    Wire.requestFrom(MPU, <span class="number">6</span>, <span class="literal">true</span>);</span><br><span class="line">    GyroX = Wire.read() &lt;&lt; <span class="number">8</span> | Wire.read();</span><br><span class="line">    GyroY = Wire.read() &lt;&lt; <span class="number">8</span> | Wire.read();</span><br><span class="line">    GyroZ = Wire.read() &lt;&lt; <span class="number">8</span> | Wire.read();</span><br><span class="line">    <span class="comment">// Sum all readings</span></span><br><span class="line">    GyroErrorX = GyroErrorX + (GyroX / <span class="number">131.0</span>);</span><br><span class="line">    GyroErrorY = GyroErrorY + (GyroY / <span class="number">131.0</span>);</span><br><span class="line">    GyroErrorZ = GyroErrorZ + (GyroZ / <span class="number">131.0</span>);</span><br><span class="line">    ave_num++;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//Divide the sum by 200 to get the error value</span></span><br><span class="line">  GyroErrorX = GyroErrorX / <span class="number">200</span>;</span><br><span class="line">  GyroErrorY = GyroErrorY / <span class="number">200</span>;</span><br><span class="line">  GyroErrorZ = GyroErrorZ / <span class="number">200</span>;</span><br><span class="line">  <span class="comment">// Print the error values on the Serial Monitor</span></span><br><span class="line"><span class="comment">//  Serial.print(&quot;AccErrorX: &quot;);</span></span><br><span class="line"><span class="comment">//  Serial.println(AccErrorX);</span></span><br><span class="line"><span class="comment">//  Serial.print(&quot;AccErrorY: &quot;);</span></span><br><span class="line"><span class="comment">//  Serial.println(AccErrorY);</span></span><br><span class="line"><span class="comment">//  Serial.print(&quot;GyroErrorX: &quot;);</span></span><br><span class="line"><span class="comment">//  Serial.println(GyroErrorX);</span></span><br><span class="line"><span class="comment">//  Serial.print(&quot;GyroErrorY: &quot;);</span></span><br><span class="line"><span class="comment">//  Serial.println(GyroErrorY);</span></span><br><span class="line"><span class="comment">//  Serial.print(&quot;GyroErrorZ: &quot;);</span></span><br><span class="line"><span class="comment">//  Serial.println(GyroErrorZ);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Kalman_Filter</span><span class="params">(<span class="type">float</span> Accel, <span class="type">float</span> Gyro)</span></span><br><span class="line">&#123;</span><br><span class="line">    Angle += (Gyro - Q_bias) * dt; <span class="comment">//先验估计</span></span><br><span class="line">    Angle_err = Accel - Angle;     <span class="comment">//zk-先验估计</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Pk-先验估计误差协方差的微分</span></span><br><span class="line">    Pdot[<span class="number">0</span>] = Q_angle - PP[<span class="number">0</span>][<span class="number">1</span>] - PP[<span class="number">1</span>][<span class="number">0</span>];</span><br><span class="line">    Pdot[<span class="number">1</span>] = -PP[<span class="number">1</span>][<span class="number">1</span>];</span><br><span class="line">    Pdot[<span class="number">2</span>] = -PP[<span class="number">1</span>][<span class="number">1</span>];</span><br><span class="line">    Pdot[<span class="number">3</span>] =  Q_gyro;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Pk-先验估计误差协方差微分的积分=先验估计误差协方差</span></span><br><span class="line">    PP[<span class="number">0</span>][<span class="number">0</span>] += Pdot[<span class="number">0</span>] * dt;</span><br><span class="line">    PP[<span class="number">0</span>][<span class="number">1</span>] += Pdot[<span class="number">1</span>] * dt;</span><br><span class="line">    PP[<span class="number">1</span>][<span class="number">0</span>] += Pdot[<span class="number">2</span>] * dt;</span><br><span class="line">    PP[<span class="number">1</span>][<span class="number">1</span>] += Pdot[<span class="number">3</span>] * dt;</span><br><span class="line"></span><br><span class="line">    PCt_0 = C_0 * PP[<span class="number">0</span>][<span class="number">0</span>];</span><br><span class="line">    PCt_1 = C_0 * PP[<span class="number">1</span>][<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    E = R_angle + C_0 * PCt_0;</span><br><span class="line"></span><br><span class="line">    K_0 = PCt_0 / E;</span><br><span class="line">    K_1 = PCt_1 / E;</span><br><span class="line"></span><br><span class="line">    t_0 = PCt_0;</span><br><span class="line">    t_1 = C_0 * PP[<span class="number">0</span>][<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 后验估计误差协方差</span></span><br><span class="line">    PP[<span class="number">0</span>][<span class="number">0</span>] -= K_0 * t_0;</span><br><span class="line">    PP[<span class="number">0</span>][<span class="number">1</span>] -= K_0 * t_1;</span><br><span class="line">    PP[<span class="number">1</span>][<span class="number">0</span>] -= K_1 * t_0;</span><br><span class="line">    PP[<span class="number">1</span>][<span class="number">1</span>] -= K_1 * t_1;</span><br><span class="line"></span><br><span class="line">    Angle    += K_0 * Angle_err;   <span class="comment">//后验估计  (最优角度)</span></span><br><span class="line">    Q_bias   += K_1 * Angle_err;   <span class="comment">//后验估计</span></span><br><span class="line">    Gyro_y   =  Gyro - Q_bias;     <span class="comment">//输出值(后验估计)的微分=角速度  (最优角速度)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="pid控制">PID控制</h3>
<p>TODO</p>
<h3 id="d建模制作小车外壳">3D建模——制作小车外壳</h3>
<p>TODO</p>
<h3 id="pcb设计制作小车电路板">PCB设计——制作小车电路板</h3>
<p>与使用面包板进行测试不同，绘制PCB板时使用的连线在打印PCB后就会固定下来，因此我们必须在编程时调用相应的引脚，这样才不会出错。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//HC06</span></span><br><span class="line"><span class="comment">//TX-&gt;Nano_Rx</span></span><br><span class="line"><span class="comment">//RX-&gt;Nano_TX</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//左电机——6个引脚</span></span><br><span class="line"><span class="type">const</span> byte L1_M1 = <span class="number">9</span>;</span><br><span class="line"><span class="comment">//L2_GND-&gt;Nano_GND</span></span><br><span class="line"><span class="type">const</span> byte L3_C1 = <span class="number">4</span>;</span><br><span class="line"><span class="type">const</span> byte L4_C2 = <span class="number">11</span>;</span><br><span class="line"><span class="comment">//L5_VCC-&gt;Nano_5V</span></span><br><span class="line"><span class="type">const</span> byte L6_M2 = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//右电机——6个引脚</span></span><br><span class="line"><span class="type">const</span> byte R1_M1 = <span class="number">5</span>;</span><br><span class="line"><span class="comment">//R2_GND-&gt;Nano_GND</span></span><br><span class="line"><span class="type">const</span> byte R3_C1 = <span class="number">3</span>;</span><br><span class="line"><span class="type">const</span> byte R4_C2 = <span class="number">2</span>;</span><br><span class="line"><span class="comment">//R5_VCC-&gt;Nano_5V</span></span><br><span class="line"><span class="type">const</span> byte R6_M2 = <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//MPU6050</span></span><br><span class="line"><span class="comment">//SCL-&gt;Nano_A5</span></span><br><span class="line"><span class="comment">//SDA-&gt;Nano_A4</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Wire.h&gt;</span></span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> MPU = <span class="number">0x68</span>; <span class="comment">// MPU6050 I2C 地址</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//MPU6050 仅计算Roll时需要的变量如下</span></span><br><span class="line"><span class="type">float</span> AccX, AccY, AccZ;</span><br><span class="line"><span class="type">float</span> GyroX;</span><br><span class="line"><span class="type">float</span> accAngleX, gyroAngleX;</span><br><span class="line"><span class="type">float</span> roll;</span><br><span class="line"><span class="type">float</span> elapsedTime, currentTime, previousTime;</span><br><span class="line"><span class="type">float</span> AccErrorX,GyroErrorX,rollError;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> byte L1_M1 = <span class="number">9</span>;</span><br><span class="line"><span class="comment">//L2_GND-&gt;Nano_GND</span></span><br><span class="line"><span class="type">const</span> byte L3_C1 = <span class="number">4</span>;</span><br><span class="line"><span class="type">const</span> byte L4_C2 = <span class="number">11</span>;</span><br><span class="line"><span class="comment">//L5_VCC-&gt;Nano_5V</span></span><br><span class="line"><span class="type">const</span> byte L6_M2 = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> byte R1_M1 = <span class="number">5</span>;</span><br><span class="line"><span class="comment">//R2_GND-&gt;Nano_GND</span></span><br><span class="line"><span class="type">const</span> byte R3_C1 = <span class="number">3</span>;</span><br><span class="line"><span class="type">const</span> byte R4_C2 = <span class="number">2</span>;</span><br><span class="line"><span class="comment">//R5_VCC-&gt;Nano_5V</span></span><br><span class="line"><span class="type">const</span> byte R6_M2 = <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span>&#123;</span><br><span class="line">  pinMode(L1_M1,OUTPUT);</span><br><span class="line">  pinMode(L6_M2,OUTPUT);</span><br><span class="line"></span><br><span class="line">  pinMode(R1_M1,OUTPUT);</span><br><span class="line">  pinMode(R6_M2,OUTPUT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="comment">//小车直行代码</span></span><br><span class="line">  analogWrite(L1_M1,<span class="number">255</span>);</span><br><span class="line">  analogWrite(L6_M2,<span class="number">0</span>);</span><br><span class="line">  analogWrite(R1_M1,<span class="number">0</span>);</span><br><span class="line">  analogWrite(R6_M2,<span class="number">255</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>记录一个可以使用的卡尔曼滤波器，直接使用下面的代码可以使用串口绘图器绘制出Roll的角度变化，打开绘图器时Roll的值记作0，然后表现为相对偏移，这个滤波器效果还不错，至少比那个一阶互补滤波器强，但是感觉相应速度不是很快。</p>
<p>主函数：</p>
<p>Kalman Filter</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//连线方法</span></span><br><span class="line"><span class="comment">// MPU-&gt;UNO</span></span><br><span class="line"><span class="comment">// VCC-&gt;VCC</span></span><br><span class="line"><span class="comment">// GND-&gt;GND</span></span><br><span class="line"><span class="comment">// SCL-&gt;A5</span></span><br><span class="line"><span class="comment">// SDA-&gt;A4</span></span><br><span class="line"><span class="comment">// INT-&gt;2 (Optional)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Kalman.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Wire.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Math.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">float</span> fRad2Deg = <span class="number">57.295779513f</span>; <span class="comment">//将弧度转为角度的乘数</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> MPU = <span class="number">0x68</span>;           <span class="comment">// MPU-6050的I2C地址</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> nValCnt = <span class="number">7</span>;          <span class="comment">//一次读取寄存器的数量</span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> nCalibTimes = <span class="number">1000</span>; <span class="comment">//校准时读数的次数</span></span><br><span class="line"><span class="type">int</span> calibData[nValCnt];       <span class="comment">//校准数据</span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> nLastTime = <span class="number">0</span>; <span class="comment">//上一次读数的时间</span></span><br><span class="line"><span class="type">float</span> fLastRoll = <span class="number">0.0f</span>;      <span class="comment">//上一次滤波得到的Roll角</span></span><br><span class="line">Kalman kalmanRoll;           <span class="comment">// Roll角滤波器</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  Serial.begin(<span class="number">9600</span>);   <span class="comment">//初始化串口，指定波特率</span></span><br><span class="line">  Wire.begin();         <span class="comment">//初始化Wire库</span></span><br><span class="line">  WriteMPUReg(<span class="number">0x6B</span>, <span class="number">0</span>); <span class="comment">//启动MPU6050设备</span></span><br><span class="line"></span><br><span class="line">  Calibration();        <span class="comment">//执行校准</span></span><br><span class="line">  nLastTime = micros(); <span class="comment">//记录当前时间</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//向串口打印输出Roll角和Pitch角，运行时在Arduino的串口监视器中查看</span></span><br><span class="line">  Serial.print(<span class="string">&quot;Roll:&quot;</span>);</span><br><span class="line">  Serial.println(GetValue());</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> <span class="title function_">GetValue</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> readouts[nValCnt];</span><br><span class="line">  ReadAccGyr(readouts); <span class="comment">//读出测量值</span></span><br><span class="line"></span><br><span class="line">  <span class="type">float</span> realVals[<span class="number">7</span>];</span><br><span class="line">  Rectify(readouts, realVals); <span class="comment">//根据校准的偏移量进行纠正</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//计算加速度向量的模长，均以g为单位</span></span><br><span class="line">  <span class="type">float</span> fNorm = <span class="built_in">sqrt</span>(realVals[<span class="number">0</span>] * realVals[<span class="number">0</span>] + realVals[<span class="number">1</span>] * realVals[<span class="number">1</span>] + realVals[<span class="number">2</span>] * realVals[<span class="number">2</span>]);</span><br><span class="line">  <span class="type">float</span> fRoll = GetRoll(realVals, fNorm); <span class="comment">//计算Roll角</span></span><br><span class="line">  <span class="keyword">if</span> (realVals[<span class="number">1</span>] &gt; <span class="number">0</span>)</span><br><span class="line">  	fRoll = -fRoll;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//计算两次测量的时间间隔dt，以秒为单位</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> nCurTime = micros();</span><br><span class="line">  <span class="type">float</span> dt = (<span class="type">double</span>)(nCurTime - nLastTime) / <span class="number">1000000.0</span>;</span><br><span class="line">  <span class="comment">//对Roll角和Pitch角进行卡尔曼滤波</span></span><br><span class="line">  <span class="type">float</span> fNewRoll = kalmanRoll.getAngle(fRoll, realVals[<span class="number">4</span>], dt);</span><br><span class="line">  <span class="comment">//跟据滤波值计算角度速</span></span><br><span class="line">  <span class="type">float</span> fRollRate = (fNewRoll - fLastRoll) / dt;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//更新Roll角和Pitch角</span></span><br><span class="line">  fLastRoll = fNewRoll;</span><br><span class="line">  <span class="comment">//更新本次测的时间</span></span><br><span class="line">  nLastTime = nCurTime;</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">return</span> fNewRoll;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//向MPU6050写入一个字节的数据</span></span><br><span class="line"><span class="comment">//指定寄存器地址与一个字节的值</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">WriteMPUReg</span><span class="params">(<span class="type">int</span> nReg, <span class="type">unsigned</span> <span class="type">char</span> nVal)</span></span><br><span class="line">&#123;</span><br><span class="line">  Wire.beginTransmission(MPU);</span><br><span class="line">  Wire.write(nReg);</span><br><span class="line">  Wire.write(nVal);</span><br><span class="line">  Wire.endTransmission(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//从MPU6050读出一个字节的数据</span></span><br><span class="line"><span class="comment">//指定寄存器地址，返回读出的值</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> <span class="title function_">ReadMPUReg</span><span class="params">(<span class="type">int</span> nReg)</span></span><br><span class="line">&#123;</span><br><span class="line">  Wire.beginTransmission(MPU);</span><br><span class="line">  Wire.write(nReg);</span><br><span class="line">  Wire.requestFrom(MPU, <span class="number">1</span>, <span class="literal">true</span>);</span><br><span class="line">  Wire.endTransmission(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Wire.read();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//从MPU6050读出加速度计三个分量、温度和三个角速度计</span></span><br><span class="line"><span class="comment">//保存在指定的数组中</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ReadAccGyr</span><span class="params">(<span class="type">int</span> *pVals)</span></span><br><span class="line">&#123;</span><br><span class="line">  Wire.beginTransmission(MPU);</span><br><span class="line">  Wire.write(<span class="number">0x3B</span>);</span><br><span class="line">  Wire.requestFrom(MPU, nValCnt * <span class="number">2</span>, <span class="literal">true</span>);</span><br><span class="line">  Wire.endTransmission(<span class="literal">true</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">long</span> i = <span class="number">0</span>; i &lt; nValCnt; ++i)</span><br><span class="line">    pVals[i] = Wire.read() &lt;&lt; <span class="number">8</span> | Wire.read();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//对大量读数进行统计，校准平均偏移量</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Calibration</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">float</span> valSums[<span class="number">7</span>] = &#123;<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0</span>&#125;; <span class="comment">//先求和</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; nCalibTimes; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="type">int</span> mpuVals[nValCnt];</span><br><span class="line">    ReadAccGyr(mpuVals);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; nValCnt; ++j)</span><br><span class="line">      valSums[j] += mpuVals[j];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//再求平均</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; nValCnt; ++i)</span><br><span class="line">    calibData[i] = <span class="type">int</span>(valSums[i] / nCalibTimes);</span><br><span class="line">  calibData[<span class="number">2</span>] += <span class="number">16384</span>; <span class="comment">//设芯片Z轴竖直向下，设定静态工作点。</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//算得Roll角。算法见文档。</span></span><br><span class="line"><span class="type">float</span> <span class="title function_">GetRoll</span><span class="params">(<span class="type">float</span> *pRealVals, <span class="type">float</span> fNorm)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">float</span> fNormXZ = <span class="built_in">sqrt</span>(pRealVals[<span class="number">0</span>] * pRealVals[<span class="number">0</span>] + pRealVals[<span class="number">2</span>] * pRealVals[<span class="number">2</span>]);</span><br><span class="line">  <span class="type">float</span> fCos = fNormXZ / fNorm;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">acos</span>(fCos) * fRad2Deg;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//对读数进行纠正，消除偏移，并转换为物理量。公式见文档。</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Rectify</span><span class="params">(<span class="type">int</span> *pReadout, <span class="type">float</span> *pRealVals)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; ++i)</span><br><span class="line">    pRealVals[i] = (<span class="type">float</span>)(pReadout[i] - calibData[i]) / <span class="number">16384.0f</span>;</span><br><span class="line"></span><br><span class="line">  pRealVals[<span class="number">3</span>] = pReadout[<span class="number">3</span>] / <span class="number">340.0f</span> + <span class="number">36.53</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">4</span>; i &lt; <span class="number">7</span>; ++i)</span><br><span class="line">    pRealVals[i] = (<span class="type">float</span>)(pReadout[i] - calibData[i]) / <span class="number">131.0f</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>新建标签："Kalman.cpp"</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Kalman.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">Kalman::Kalman() </span><br><span class="line">&#123;</span><br><span class="line">  Q_angle = <span class="number">0.001f</span>;</span><br><span class="line">  Q_bias = <span class="number">0.003f</span>;</span><br><span class="line">  R_measure = <span class="number">0.03f</span>;</span><br><span class="line"></span><br><span class="line">  angle = <span class="number">0.0f</span>;</span><br><span class="line">  bias = <span class="number">0.0f</span>;</span><br><span class="line"></span><br><span class="line">  P[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">0.0f</span>;</span><br><span class="line">  P[<span class="number">0</span>][<span class="number">1</span>] = <span class="number">0.0f</span>;</span><br><span class="line">  P[<span class="number">1</span>][<span class="number">0</span>] = <span class="number">0.0f</span>;</span><br><span class="line">  P[<span class="number">1</span>][<span class="number">1</span>] = <span class="number">0.0f</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">float</span> <span class="title function_">Kalman::getAngle</span><span class="params">(<span class="type">float</span> newAngle, <span class="type">float</span> newRate, <span class="type">float</span> dt)</span> </span><br><span class="line">&#123;</span><br><span class="line">  rate = newRate - bias;</span><br><span class="line">  angle += dt * rate;</span><br><span class="line">  P[<span class="number">0</span>][<span class="number">0</span>] += dt * (dt * P[<span class="number">1</span>][<span class="number">1</span>] - P[<span class="number">0</span>][<span class="number">1</span>] - P[<span class="number">1</span>][<span class="number">0</span>] + Q_angle);</span><br><span class="line">  P[<span class="number">0</span>][<span class="number">1</span>] -= dt * P[<span class="number">1</span>][<span class="number">1</span>];</span><br><span class="line">  P[<span class="number">1</span>][<span class="number">0</span>] -= dt * P[<span class="number">1</span>][<span class="number">1</span>];</span><br><span class="line">  P[<span class="number">1</span>][<span class="number">1</span>] += Q_bias * dt;</span><br><span class="line"></span><br><span class="line">  <span class="type">float</span> S = P[<span class="number">0</span>][<span class="number">0</span>] + R_measure;</span><br><span class="line">  <span class="type">float</span> K[<span class="number">2</span>];</span><br><span class="line">  K[<span class="number">0</span>] = P[<span class="number">0</span>][<span class="number">0</span>] / S;</span><br><span class="line">  K[<span class="number">1</span>] = P[<span class="number">1</span>][<span class="number">0</span>] / S;</span><br><span class="line"></span><br><span class="line">  <span class="type">float</span> y = newAngle - angle;</span><br><span class="line">  angle += K[<span class="number">0</span>] * y;</span><br><span class="line">  bias += K[<span class="number">1</span>] * y;</span><br><span class="line"></span><br><span class="line">  <span class="type">float</span> P00_temp = P[<span class="number">0</span>][<span class="number">0</span>];</span><br><span class="line">  <span class="type">float</span> P01_temp = P[<span class="number">0</span>][<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  P[<span class="number">0</span>][<span class="number">0</span>] -= K[<span class="number">0</span>] * P00_temp;</span><br><span class="line">  P[<span class="number">0</span>][<span class="number">1</span>] -= K[<span class="number">0</span>] * P01_temp;</span><br><span class="line">  P[<span class="number">1</span>][<span class="number">0</span>] -= K[<span class="number">1</span>] * P00_temp;</span><br><span class="line">  P[<span class="number">1</span>][<span class="number">1</span>] -= K[<span class="number">1</span>] * P01_temp;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> angle;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Kalman::setAngle</span><span class="params">(<span class="type">float</span> angle)</span> </span><br><span class="line">&#123;</span><br><span class="line">  this-&gt;angle = angle;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">float</span> <span class="title function_">Kalman::getRate</span><span class="params">()</span> </span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> this-&gt;rate;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Kalman::setQangle</span><span class="params">(<span class="type">float</span> Q_angle)</span> </span><br><span class="line">&#123;</span><br><span class="line">  this-&gt;Q_angle = Q_angle;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Kalman::setQbias</span><span class="params">(<span class="type">float</span> Q_bias)</span> </span><br><span class="line">&#123;</span><br><span class="line">  this-&gt;Q_bias = Q_bias;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Kalman::setRmeasure</span><span class="params">(<span class="type">float</span> R_measure)</span> </span><br><span class="line">&#123;</span><br><span class="line">  this-&gt;R_measure = R_measure;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">float</span> <span class="title function_">Kalman::getQangle</span><span class="params">()</span> </span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> this-&gt;Q_angle;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">float</span> <span class="title function_">Kalman::getQbias</span><span class="params">()</span> </span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> this-&gt;Q_bias;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">float</span> <span class="title function_">Kalman::getRmeasure</span><span class="params">()</span> </span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> this-&gt;R_measure;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>新建标签"Kalman.h"</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _Kalman_h_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _Kalman_h_</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Kalman</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  public:</span><br><span class="line">    Kalman();</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> <span class="title function_">getAngle</span><span class="params">(<span class="type">float</span> newAngle, <span class="type">float</span> newRate, <span class="type">float</span> dt)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> <span class="title function_">setAngle</span><span class="params">(<span class="type">float</span> angle)</span>;</span><br><span class="line">    <span class="type">float</span> <span class="title function_">getRate</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> <span class="title function_">setQangle</span><span class="params">(<span class="type">float</span> Q_angle)</span>;</span><br><span class="line">    <span class="type">void</span> <span class="title function_">setQbias</span><span class="params">(<span class="type">float</span> Q_bias)</span>;</span><br><span class="line">    <span class="type">void</span> <span class="title function_">setRmeasure</span><span class="params">(<span class="type">float</span> R_measure)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> <span class="title function_">getQangle</span><span class="params">()</span>;</span><br><span class="line">    <span class="type">float</span> <span class="title function_">getQbias</span><span class="params">()</span>;</span><br><span class="line">    <span class="type">float</span> <span class="title function_">getRmeasure</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">  private:</span><br><span class="line">    <span class="type">float</span> Q_angle;</span><br><span class="line">    <span class="type">float</span> Q_bias;</span><br><span class="line">    <span class="type">float</span> R_measure;</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> angle;</span><br><span class="line">    <span class="type">float</span> bias;</span><br><span class="line">    <span class="type">float</span> rate;</span><br><span class="line">    </span><br><span class="line">    <span class="type">float</span> P[<span class="number">2</span>][<span class="number">2</span>];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Kalman_Filter(Adxl_angle, Gyro_sensor); <span class="comment">//卡尔曼融合获取angle</span></span><br><span class="line">Input = angle;</span><br><span class="line">myPID.Compute();  <span class="comment">//PID计算获取 Output</span></span><br><span class="line">Drive(Output);   <span class="comment">//根据Output驱动电机</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//连线方法</span></span><br><span class="line"><span class="comment">// MPU-&gt;UNO</span></span><br><span class="line"><span class="comment">// VCC-&gt;VCC</span></span><br><span class="line"><span class="comment">// GND-&gt;GND</span></span><br><span class="line"><span class="comment">// SCL-&gt;A5</span></span><br><span class="line"><span class="comment">// SDA-&gt;A4</span></span><br><span class="line"><span class="comment">// INT-&gt;2 (Optional)</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;PID_v1.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Kalman.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Wire.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Math.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">double</span> Setpoint, Input, Output;</span><br><span class="line"><span class="type">float</span> fRad2Deg = <span class="number">57.295779513f</span>; <span class="comment">//将弧度转为角度的乘数</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> MPU = <span class="number">0x68</span>;           <span class="comment">// MPU-6050的I2C地址</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> nValCnt = <span class="number">7</span>;          <span class="comment">//一次读取寄存器的数量</span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> nCalibTimes = <span class="number">1000</span>; <span class="comment">//校准时读数的次数</span></span><br><span class="line"><span class="type">int</span> calibData[nValCnt];       <span class="comment">//校准数据</span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> nLastTime = <span class="number">0</span>; <span class="comment">//上一次读数的时间</span></span><br><span class="line"><span class="type">float</span> fLastRoll = <span class="number">0.0f</span>;      <span class="comment">//上一次滤波得到的Roll角</span></span><br><span class="line">Kalman kalmanRoll;           <span class="comment">// Roll角滤波器</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//左电机——6个引脚</span></span><br><span class="line"><span class="type">const</span> byte L1_M1 = <span class="number">9</span>;</span><br><span class="line"><span class="comment">//L2_GND-&gt;Nano_GND</span></span><br><span class="line"><span class="type">const</span> byte L3_C1 = <span class="number">4</span>;</span><br><span class="line"><span class="type">const</span> byte L4_C2 = <span class="number">11</span>;</span><br><span class="line"><span class="comment">//L5_VCC-&gt;Nano_5V</span></span><br><span class="line"><span class="type">const</span> byte L6_M2 = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//右电机——6个引脚</span></span><br><span class="line"><span class="type">const</span> byte R1_M1 = <span class="number">5</span>;</span><br><span class="line"><span class="comment">//R2_GND-&gt;Nano_GND</span></span><br><span class="line"><span class="type">const</span> byte R3_C1 = <span class="number">3</span>;</span><br><span class="line"><span class="type">const</span> byte R4_C2 = <span class="number">2</span>;</span><br><span class="line"><span class="comment">//R5_VCC-&gt;Nano_5V</span></span><br><span class="line"><span class="type">const</span> byte R6_M2 = <span class="number">6</span>;</span><br><span class="line">  PID <span class="title function_">myPID</span><span class="params">(&amp;Input, &amp;Output, &amp;Setpoint,<span class="number">2</span>,<span class="number">5</span>,<span class="number">1</span>, DIRECT)</span>; <span class="comment">//PID对象声明</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  Serial.begin(<span class="number">9600</span>);   <span class="comment">//初始化串口，指定波特率</span></span><br><span class="line">  Wire.begin();         <span class="comment">//初始化Wire库</span></span><br><span class="line">  WriteMPUReg(<span class="number">0x6B</span>, <span class="number">0</span>); <span class="comment">//启动MPU6050设备</span></span><br><span class="line"></span><br><span class="line">  Calibration();        <span class="comment">//执行校准</span></span><br><span class="line">  nLastTime = micros(); <span class="comment">//记录当前时间</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">  setupPID();  <span class="comment">//PID初始化</span></span><br><span class="line">    </span><br><span class="line">  pinMode(L1_M1,OUTPUT);</span><br><span class="line">  pinMode(L6_M2,OUTPUT);</span><br><span class="line"></span><br><span class="line">  pinMode(R1_M1,OUTPUT);</span><br><span class="line">  pinMode(R6_M2,OUTPUT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//向串口打印输出Roll角和Pitch角，运行时在Arduino的串口监视器中查看</span></span><br><span class="line">  Serial.print(<span class="string">&quot;Roll:&quot;</span>);</span><br><span class="line">  Serial.println();</span><br><span class="line">  </span><br><span class="line">  Input = GetValue();</span><br><span class="line">  myPID.Compute();  <span class="comment">//PID计算获取 Output</span></span><br><span class="line">  Drive(Output);   <span class="comment">//根据Output驱动电机</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Drive</span><span class="params">(<span class="type">float</span> Output)</span></span><br><span class="line">&#123;    </span><br><span class="line">  analogWrite(L1_M1,Output);</span><br><span class="line">  analogWrite(L6_M2,<span class="number">0</span>);</span><br><span class="line">  analogWrite(R1_M1,<span class="number">0</span>);</span><br><span class="line">  analogWrite(R6_M2,Output);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">setupPID</span><span class="params">()</span>&#123;</span><br><span class="line">  Input = <span class="number">0</span>;</span><br><span class="line">  Setpoint = <span class="number">17</span>;  <span class="comment">//我的小车自平衡角度为17</span></span><br><span class="line">  myPID.SetSampleTime(<span class="number">100</span>);  <span class="comment">//控制器的采样时间100ms</span></span><br><span class="line">  <span class="comment">//myPID.SetOutputLimits(0, 2000); </span></span><br><span class="line">  myPID.SetMode(AUTOMATIC);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> <span class="title function_">GetValue</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> readouts[nValCnt];</span><br><span class="line">  ReadAccGyr(readouts); <span class="comment">//读出测量值</span></span><br><span class="line"></span><br><span class="line">  <span class="type">float</span> realVals[<span class="number">7</span>];</span><br><span class="line">  Rectify(readouts, realVals); <span class="comment">//根据校准的偏移量进行纠正</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//计算加速度向量的模长，均以g为单位</span></span><br><span class="line">  <span class="type">float</span> fNorm = <span class="built_in">sqrt</span>(realVals[<span class="number">0</span>] * realVals[<span class="number">0</span>] + realVals[<span class="number">1</span>] * realVals[<span class="number">1</span>] + realVals[<span class="number">2</span>] * realVals[<span class="number">2</span>]);</span><br><span class="line">  <span class="type">float</span> fRoll = GetRoll(realVals, fNorm); <span class="comment">//计算Roll角</span></span><br><span class="line">  <span class="keyword">if</span> (realVals[<span class="number">1</span>] &gt; <span class="number">0</span>)</span><br><span class="line">    fRoll = -fRoll;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//计算两次测量的时间间隔dt，以秒为单位</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> nCurTime = micros();</span><br><span class="line">  <span class="type">float</span> dt = (<span class="type">double</span>)(nCurTime - nLastTime) / <span class="number">1000000.0</span>;</span><br><span class="line">  <span class="comment">//对Roll角和Pitch角进行卡尔曼滤波</span></span><br><span class="line">  <span class="type">float</span> fNewRoll = kalmanRoll.getAngle(fRoll, realVals[<span class="number">4</span>], dt);</span><br><span class="line">  <span class="comment">//跟据滤波值计算角度速</span></span><br><span class="line">  <span class="type">float</span> fRollRate = (fNewRoll - fLastRoll) / dt;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//更新Roll角和Pitch角</span></span><br><span class="line">  fLastRoll = fNewRoll;</span><br><span class="line">  <span class="comment">//更新本次测的时间</span></span><br><span class="line">  nLastTime = nCurTime;</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">return</span> fNewRoll;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//向MPU6050写入一个字节的数据</span></span><br><span class="line"><span class="comment">//指定寄存器地址与一个字节的值</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">WriteMPUReg</span><span class="params">(<span class="type">int</span> nReg, <span class="type">unsigned</span> <span class="type">char</span> nVal)</span></span><br><span class="line">&#123;</span><br><span class="line">  Wire.beginTransmission(MPU);</span><br><span class="line">  Wire.write(nReg);</span><br><span class="line">  Wire.write(nVal);</span><br><span class="line">  Wire.endTransmission(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//从MPU6050读出一个字节的数据</span></span><br><span class="line"><span class="comment">//指定寄存器地址，返回读出的值</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> <span class="title function_">ReadMPUReg</span><span class="params">(<span class="type">int</span> nReg)</span></span><br><span class="line">&#123;</span><br><span class="line">  Wire.beginTransmission(MPU);</span><br><span class="line">  Wire.write(nReg);</span><br><span class="line">  Wire.requestFrom(MPU, <span class="number">1</span>, <span class="literal">true</span>);</span><br><span class="line">  Wire.endTransmission(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Wire.read();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//从MPU6050读出加速度计三个分量、温度和三个角速度计</span></span><br><span class="line"><span class="comment">//保存在指定的数组中</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">ReadAccGyr</span><span class="params">(<span class="type">int</span> *pVals)</span></span><br><span class="line">&#123;</span><br><span class="line">  Wire.beginTransmission(MPU);</span><br><span class="line">  Wire.write(<span class="number">0x3B</span>);</span><br><span class="line">  Wire.requestFrom(MPU, nValCnt * <span class="number">2</span>, <span class="literal">true</span>);</span><br><span class="line">  Wire.endTransmission(<span class="literal">true</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">long</span> i = <span class="number">0</span>; i &lt; nValCnt; ++i)</span><br><span class="line">    pVals[i] = Wire.read() &lt;&lt; <span class="number">8</span> | Wire.read();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//对大量读数进行统计，校准平均偏移量</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Calibration</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">float</span> valSums[<span class="number">7</span>] = &#123;<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0</span>&#125;; <span class="comment">//先求和</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; nCalibTimes; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="type">int</span> mpuVals[nValCnt];</span><br><span class="line">    ReadAccGyr(mpuVals);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; nValCnt; ++j)</span><br><span class="line">      valSums[j] += mpuVals[j];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//再求平均</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; nValCnt; ++i)</span><br><span class="line">    calibData[i] = <span class="type">int</span>(valSums[i] / nCalibTimes);</span><br><span class="line">  calibData[<span class="number">2</span>] += <span class="number">16384</span>; <span class="comment">//设芯片Z轴竖直向下，设定静态工作点。</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//算得Roll角。算法见文档。</span></span><br><span class="line"><span class="type">float</span> <span class="title function_">GetRoll</span><span class="params">(<span class="type">float</span> *pRealVals, <span class="type">float</span> fNorm)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">float</span> fNormXZ = <span class="built_in">sqrt</span>(pRealVals[<span class="number">0</span>] * pRealVals[<span class="number">0</span>] + pRealVals[<span class="number">2</span>] * pRealVals[<span class="number">2</span>]);</span><br><span class="line">  <span class="type">float</span> fCos = fNormXZ / fNorm;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">acos</span>(fCos) * fRad2Deg;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//对读数进行纠正，消除偏移，并转换为物理量。公式见文档。</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">Rectify</span><span class="params">(<span class="type">int</span> *pReadout, <span class="type">float</span> *pRealVals)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; ++i)</span><br><span class="line">    pRealVals[i] = (<span class="type">float</span>)(pReadout[i] - calibData[i]) / <span class="number">16384.0f</span>;</span><br><span class="line"></span><br><span class="line">  pRealVals[<span class="number">3</span>] = pReadout[<span class="number">3</span>] / <span class="number">340.0f</span> + <span class="number">36.53</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">4</span>; i &lt; <span class="number">7</span>; ++i)</span><br><span class="line">    pRealVals[i] = (<span class="type">float</span>)(pReadout[i] - calibData[i]) / <span class="number">131.0f</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>如果有帮助请我喝杯咖啡吧(●'◡'●)</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.png" alt="邱金羽 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="/images/alipay.png" alt="邱金羽 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>邱金羽
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://y006.github.io/2022/02/25/19-20-54/" title="双轮自平衡小车制作指南">https://y006.github.io/2022/02/25/19-20-54/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/%E7%94%B5%E5%AD%90%E8%AE%BE%E8%AE%A1/" rel="tag"># 电子设计</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/02/25/11-07-35/" rel="prev" title="蓝桥杯">
                  <i class="fa fa-chevron-left"></i> 蓝桥杯
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/02/27/16-41-11/" rel="next" title="写给电子专业同学的C语言教程">
                  写给电子专业同学的C语言教程 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">邱金羽</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  





  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"all","js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js","integrity":"sha256-r+3itOMtGGjap0x+10hu6jW/gZCzxHsoKrOd7gyRSGY="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"Bolgqjy","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
